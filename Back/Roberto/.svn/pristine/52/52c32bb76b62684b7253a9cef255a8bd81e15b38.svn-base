
var MMAdminRanches = {};
MMAdminRanches.editMode = false;
MMAdminRanches.ranch = {};

MMAdminRanches.map = false;
MMAdminRanches.marker=null;
MMAdminRanches.location=null;

MMAdminRanches.ranch.ranchFileManager = {};
    
$(document).ready(
    function(){
        MMAdminRanches.editMode = $('#selectedRanchId').length>0;
        if($('#savePositions').length>0){
            $('#adminPositions').sortable();

            $('#savePositions').on({
                'click':function(){
                    MMAdminRanches.savePositions();
                }
            });
        }
        else{
            if($('#addRanch').length>0){
                $('#addRanch').on({
                    'click':function(){
                        if(MMAdminRanches.editMode)
                            MMAdminRanches.save();
                        else
                            MMAdminRanches.add();
                    }
                });
            }

            if(MMAdminRanches.editMode){
                $('#deleteRanch, #deleteRanchTrash').on({
                    'click':function(){
                        var id = parseInt($('#selectedRanchId').val());
                        if(id!==0)
                            if(confirm($('#confirmationText').val()))
                                MMAdminRanches.remove(id);
                    }
                });
                MMAdminRanches.searchThroughTableBinds();
                MMAdminRanches.checkSelectedRanch();
            }
            else{
                if($('#active').length>0)
                    $('#active').attr('class','adminCheckboxChecked');
            }    

            
            MMAdminRanches.ranchFileManager = FileManager.newInstance('ranchFile','ranchFile',false,new Array());
            MMAdminRanches.ranchFileManager.start();
            
            Tools.delay(1000, MMAdminRanches.setGoogleMap);
        }
});

MMAdminRanches.add = function(){
    MMAdminRanches.updateRanchData();
    var loadCode = Tools.showLoading();
    $.ajax({
        type: 'POST',
        url: '/index.php/Ranches/add',
        data:{'ranch':(MMAdminRanches.ranch)},
        success: function(response){
            response = $.parseJSON(response);
            if(response.status==='ok'){
                Tools.removeLoading(loadCode);
                Tools.alert(response.message,1,function(){Tools.redirect('/Ranches/viewEdit/'+response.id);});
            }
            else if(response.status==='error'){
                Tools.alert(response.errorMessage);
                Tools.removeLoading(loadCode);
            }
            else{
                Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
                Tools.removeLoading(loadCode);
            }
        },
        error: function(){
            Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            Tools.removeLoading(loadCode);
        }
    });
};
    
MMAdminRanches.save = function(){
    MMAdminRanches.updateRanchData();
    var loadCode = Tools.showLoading();
    $.ajax({
        type: 'POST',
        url: '/index.php/Ranches/save',
        data:{'ranch':(MMAdminRanches.ranch)},
        success: function(response){
            response = $.parseJSON(response);
            if(response.status==='ok'){
                Tools.removeLoading(loadCode);
                Tools.alert(response.message,1,function(){Tools.redirect('/Ranches/viewEdit/'+MMAdminRanches.ranch.id);});
            }
            else if(response.status==='error'){
                Tools.alert(response.errorMessage);
                Tools.removeLoading(loadCode);
            }
            else{
                Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
                Tools.removeLoading(loadCode);
            }
        },
        error: function(){
            Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            Tools.removeLoading(loadCode);
        }
    });
};

MMAdminRanches.savePositions = function(){
    var ranchIds = new Array();
    $('.adminPosition').each(function() {
        ranchIds[ranchIds.length] = $(this).attr('id');
    });
    
    var loadCode = Tools.showLoading();
    $.ajax({
        type: 'POST',
        url: '/Ranches/savePositions',
        data:{'ranchIds':(ranchIds)},
        success: function(response){
            response = $.parseJSON(response);
            if(response.status==='ok'){
                Tools.alert(response.message);
            }
            else if(response.status==='error'){
                Tools.alert(response.errorMessage);
            }
            else{
                Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            }
            Tools.removeLoading(loadCode);
        },
        error: function(){
            Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            Tools.removeLoading(loadCode);
        }
    });
};



    
MMAdminRanches.remove = function(id){
    var loadCode = Tools.showLoading();
    $.ajax({
        type: 'POST',
        url: '/index.php/Ranches/delete',
        data:{'id':(id)},
        success: function(response){
            response = $.parseJSON(response);
            if(response.status==='ok'){
                Tools.removeLoading(loadCode);
                Tools.alert(response.message,1,function(){Tools.redirect('/Ranches/viewEdit');});
            }
            else if(response.status==='error'){
                Tools.alert(response.errorMessage);
                Tools.removeLoading(loadCode);
            }
            else{
                Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
                Tools.removeLoading(loadCode);
            }
        },
        error: function(){
            Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            Tools.removeLoading(loadCode);
        }
    });
};
    
MMAdminRanches.updateRanchData = function(){
    var selectedRanchId = parseInt($('#selectedRanchId').val());
    if(!isNaN(selectedRanchId) && selectedRanchId!==0)
        MMAdminRanches.ranch.id = selectedRanchId
    else if($('#ranchId').length>0)
        MMAdminRanches.ranch.id = $('#ranchId').val();
    else
        MMAdminRanches.ranch.id = 0;
    MMAdminRanches.ranch.name = $('#name').val();
    MMAdminRanches.ranch.description = $('#description').val();
    MMAdminRanches.ranch.ranch_file_id = MMAdminRanches.getRanchFile();
    
    MMAdminRanches.ranch.lat="";
    MMAdminRanches.ranch.long="";
    if(MMAdminRanches.marker!==null){
        MMAdminRanches.ranch.lat=MMAdminRanches.location.lat();
        MMAdminRanches.ranch.long=MMAdminRanches.location.lng();
    }
};
    
MMAdminRanches.checkSelectedRanch = function(){
    var id = parseInt($('#ranchId').val());
    if(!isNaN(id) && id!==0){
        $('#selectedRanchId').val(id);
        MMAdminRanches.loadRanch(id);
    }
};
    
MMAdminRanches.loadRanch = function(id){
    var loadCode = Tools.showLoading();
    $.ajax({
        type: 'POST',
        url: '/index.php/Ranches/getArray',
        data:{'id':(id)},
        success: function(response){
            response = $.parseJSON(response);
            if(response.status==='ok'){
                MMAdminRanches.setRanch(response.ranch);
            }
            else{
                Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            }
            Tools.removeLoading(loadCode);
        },
        error: function(){
            Tools.alert('Error obteniendo datos del sitio, verifique su conexión a internet.');
            Tools.removeLoading(loadCode);
        }
    });
};
    
MMAdminRanches.setRanch = function(ranch){
    MMAdminRanches.ranch = ranch;
    $('#id').val(ranch.id);
    $('#name').val(ranch.name);
    $('#description').val(ranch.description);
    MMAdminRanches.addRanchFile();
    Tools.delay(1000, 
        function(){
            MMAdminRanches.placeMarker(new google.maps.LatLng(ranch.lat, ranch.long));
        }
    );
};
        

        

            
//------------------------------------------------------------------------------
//----------------------------------RanchFileId----------------------------------
//------------------------------------------------------------------------------
MMAdminRanches.getRanchFile = function(){
    var file = MMAdminRanches.ranchFileManager.getFiles();
    if(file!==false)
        return file.id;
    else
        return '';
};

MMAdminRanches.addRanchFile = function(){
    if(MMAdminRanches.ranch.ranchFile.length!==0)
        MMAdminRanches.ranchFileManager.updateFiles([MMAdminRanches.ranch.ranchFile]);
    else
        MMAdminRanches.ranchFileManager.updateFiles([]);
};


            
//------------------------------------------------------------------------------
//---------------------------SearchThroughTables--------------------------------
//------------------------------------------------------------------------------



MMAdminRanches.searchThroughTableBinds = function(){

   $('#selectedRanchId').on({
       'change':function(){
            var id = $(this).val();
            if(!isNaN(id) && id!==0)
                MMAdminRanches.loadRanch(id);
        }
   });
};

//------------------------------------------------------------------------------
//------------------------------------Maps--------------------------------------
//------------------------------------------------------------------------------

MMAdminRanches.setGoogleMap=function(){
    var mapCanvas = document.getElementById('map-canvas');
    var mapOptions = {
      center: new google.maps.LatLng(-34.9016304,-56.2566484),
      zoom: 8,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    MMAdminRanches.map = new google.maps.Map(mapCanvas, mapOptions);
    google.maps.event.addListener(MMAdminRanches.map, 'click', function(event) {
        MMAdminRanches.placeMarker(event.latLng);
     });
};

MMAdminRanches.placeMarker=function(location){
     MMAdminRanches.location=location;
    
    var marker = new google.maps.Marker({
        position: MMAdminRanches.location, 
        map: MMAdminRanches.map
    });

    if(MMAdminRanches.marker!==null){
       MMAdminRanches.marker.setMap(null);
    }

    MMAdminRanches.marker=marker;
    MMAdminRanches.map.setCenter(location);
};